name: CI-Appium-Maven

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  android-tests:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the code
      - uses: actions/checkout@v4

      # 2. Set up Java (for Maven & Appium)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # 3. Set up Node.js (for Appium server)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 4. Install Appium globally
      - name: Install Appium
        run: npm install -g appium

      # 5. Set up Android SDK and emulator
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 33
          build-tools: '33.0.2'
          target: android-33
          emulator: true

      # 6. Start Android emulator
      - name: Start Android emulator
        run: |
          echo "Starting emulator..."
          $ANDROID_HOME/emulator/emulator -avd test -no-audio -no-window &
          adb wait-for-device
          adb shell input keyevent 82

      # 7. Start Appium server in the background
      - name: Start Appium server
        run: appium &

      # 8. Build project and run Maven Appium tests
      - name: Run Maven tests
        run: mvn clean test
